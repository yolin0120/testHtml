<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帶參數的 QR Code 產生器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 QR Code 生成函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .input-group {
            margin-bottom: 1.5rem;
        }
        #qrcode-container {
            width: 256px;
            height: 256px;
            margin: 1.5rem auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: white;
            transition: all 0.3s ease;
        }
        #qrcode-container.empty {
            background-color: #f9fafb;
        }
        .generated-url-container {
            word-wrap: break-word;
            background-color: #f3f4f6;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            font-family: monospace;
            color: #1f2937;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container bg-white shadow-lg rounded-lg">
        <div class="text-center">
            <h1 class="text-2xl font-bold text-gray-800">回報表單 QR Code 產生器</h1>
            <p class="mt-2 text-gray-600">請填入下方資訊，即可即時產生帶有指定序號的 QR Code。</p>
            <!-- 新增的區塊，用來顯示從網址帶入的序號，預設隱藏 -->
            <div id="serial-display" class="mt-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg" style="display: none;">
                <label for="serial-field" class="block text-sm font-medium text-indigo-800 mb-1">偵測到網址帶入的序號</label>
                <input type="text" id="serial-field" name="product_serial" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-center" readonly>
            </div>
        </div>

        <div class="mt-8">
            <!-- 表單網址 -->
            <div class="input-group">
                <label for="baseUrl" class="block text-sm font-medium text-gray-700 mb-1">1. 回報表單的基礎網址</label>
                <input type="url" id="baseUrl" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：https://www.example.com/report">
            </div>

            <!-- 參數名稱 -->
            <div class="input-group">
                <label for="paramName" class="block text-sm font-medium text-gray-700 mb-1">2. 序號的參數名稱 (Key)</label>
                <input type="text" id="paramName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：serial_number 或 sn">
            </div>

            <!-- 序號值 -->
            <div class="input-group">
                <label for="paramValue" class="block text-sm font-medium text-gray-700 mb-1">3. 這次要帶入的序號 (Value)</label>
                <input type="text" id="paramValue" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：ABC-12345-XYZ">
            </div>
        </div>

        <div class="mt-6">
             <h2 class="text-lg font-semibold text-gray-800">產生的結果</h2>
            <div class="generated-url-container">
                <p id="generatedUrl" class="text-sm">請在上方填寫資訊...</p>
            </div>
            <div id="qrcode-container" class="empty">
                <span id="qrcode-placeholder" class="text-gray-500">QR Code 將顯示於此</span>
                <canvas id="qrcode-canvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        const baseUrlInput = document.getElementById('baseUrl');
        const paramNameInput = document.getElementById('paramName');
        const paramValueInput = document.getElementById('paramValue');
        const generatedUrlOutput = document.getElementById('generatedUrl');
        const qrcodeContainer = document.getElementById('qrcode-container');
        const qrcodePlaceholder = document.getElementById('qrcode-placeholder');
        const canvas = document.getElementById('qrcode-canvas');

        // 處理從網址帶入的序號
        document.addEventListener('DOMContentLoaded', function() {
            // 1. 解析網址參數
            const urlParams = new URLSearchParams(window.location.search);
            
            // 2. 取得名為 "sn" 的參數值
            const serialNumber = urlParams.get('sn');
            
            // 3. 如果有成功取得到序號
            if (serialNumber) {
                const serialDisplayDiv = document.getElementById('serial-display');
                const serialInputField = document.getElementById('serial-field');

                // 顯示並填入序號顯示框
                if (serialDisplayDiv && serialInputField) {
                    serialInputField.value = serialNumber;
                    serialDisplayDiv.style.display = 'block';
                }

                // 4. 將參數名稱 'sn' 和序號值預填到產生器對應的欄位
                paramNameInput.value = 'sn';
                paramValueInput.value = serialNumber;

                // 5. 將欄位設為唯讀並改變樣式，防止使用者修改
                paramNameInput.readOnly = true;
                paramNameInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                paramValueInput.readOnly = true;
                paramValueInput.classList.add('bg-gray-100', 'cursor-not-allowed');

                // 6. 將焦點移至基礎網址輸入框，引導使用者
                baseUrlInput.focus();
                baseUrlInput.placeholder = "請在這裡輸入回報表單網址";

                // 自動觸發一次產生，以顯示提示訊息 (如果 base url 為空)
                generate();
            }
        });


        function generate() {
            const baseUrl = baseUrlInput.value.trim();
            const paramName = paramNameInput.value.trim();
            const paramValue = paramValueInput.value.trim();

            // 如果欄位不完整，就顯示預設訊息
            if (!paramName || !paramValue) {
                generatedUrlOutput.textContent = '請在上方填寫所有資訊...';
                qrcodeContainer.classList.add('empty');
                qrcodePlaceholder.style.display = 'block';
                qrcodePlaceholder.textContent = 'QR Code 將顯示於此';
                canvas.style.display = 'none';
                return;
            }
            
            // 如果只有基礎網址是空的，顯示特定提示
            if (!baseUrl) {
                generatedUrlOutput.innerHTML = '<span class="text-red-600 font-semibold">請輸入「回報表單的基礎網址」以產生 QR Code。</span>';
                qrcodeContainer.classList.add('empty');
                qrcodePlaceholder.style.display = 'block';
                qrcodePlaceholder.textContent = '等待基礎網址...';
                canvas.style.display = 'none';
                // 清除舊的 canvas 內容
                const context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            // 檢查網址是否已經有 '?'
            const separator = baseUrl.includes('?') ? '&' : '?';
            
            // 使用 encodeURIComponent 來確保特殊字元被正確編碼
            const fullUrl = `${baseUrl}${separator}${encodeURIComponent(paramName)}=${encodeURIComponent(paramValue)}`;

            generatedUrlOutput.textContent = fullUrl;
            
            qrcodePlaceholder.style.display = 'none';
            canvas.style.display = 'block';
            qrcodeContainer.classList.remove('empty');

            QRCode.toCanvas(canvas, fullUrl, { width: 256, margin: 1 }, function (error) {
                if (error) {
                    console.error(error);
                    generatedUrlOutput.textContent = '產生 QR Code 時發生錯誤。';
                    qrcodePlaceholder.textContent = '產生失敗';
                    qrcodePlaceholder.style.display = 'block';
                    canvas.style.display = 'none';
                }
            });
        }

        // 監聽所有輸入框的輸入事件
        [baseUrlInput, paramNameInput, paramValueInput].forEach(input => {
            input.addEventListener('input', generate);
        });

        // 初始載入時也執行一次
        generate();
    </script>
</body>
</html>

